(function(e){e.fn.smartAutoComplete=function(){if(arguments.length<1){var t=this[0];return e(t).data("smart-autocomplete")}var n=function(t,n,r){var i=new RegExp(t.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&"),"i");return e.grep(n,function(e){return i.test(e)})};var r={minCharLimit:1,maxCharLimit:null,maxResults:null,delay:0,disabled:false,forceSelect:false,typeAhead:false,resultElement:"li",resultFormatter:function(e){return"<li>"+e+"</li>"},filter:function(t,r){var i=this;var s=e(i).data("smart-autocomplete");if(e.type(r)==="array"){var o=n(t,r,i);return o}else if(e.type(r)==="string"){return e.Deferred(function(s){e.ajax({url:r,data:{term:t},dataType:"json"}).done(function(e){s.resolve(n(t,e,i))})}).promise()}},alignResultsContainer:false,clearResults:function(){var t=e(this.context).prev(".smart_autocomplete_type_ahead_field");e(this.context).css({background:t.css("background")});t.remove();e(this.resultsContainer).html("")},setCurrentSelectionToContext:function(){if(this.rawResults.length>0&&this.currentSelection>=0)e(this.context).val(this.rawResults[this.currentSelection])},setItemSelected:function(e){this.itemSelected=e},autocompleteFocused:false,setAutocompleteFocused:function(e){this.autocompleteFocused=e}};e.event.special.keyIn={setup:function(){return false},_default:function(t){var n=t.target;var r=e(n).data("smart-autocomplete");var i=r.source||null;var s=r.filter;var o=r.maxCharLimit>0?r.maxCharLimit:Number.POSITIVE_INFINITY;var u=t.smartAutocompleteData.query;if(r.disabled||u.length>o){e(n).trigger("lostFocus");return false}r.setItemSelected(false);r.setAutocompleteFocused(true);setTimeout(function(){e.when(s.apply(r,[u,r.source])).done(function(t){var i=r.maxResults>0?t.splice(0,r.maxResults):t;e(n).trigger("resultsReady",[i])})},r.delay)}};e.event.special.resultsReady={setup:function(){return false},_default:function(t){var n=t.target;var r=e(n).data("smart-autocomplete");var i=t.smartAutocompleteData.results;if(r.disabled)return false;e(n).smartAutoComplete().clearResults();r.rawResults=i;if(i.length<1){e(n).trigger("noResults");return false}var s=e.map(i,function(e){return r.resultFormatter.apply(r,[e])});var o=s.join("");if(r.resultsContainer)e(r.resultsContainer).append(o);e(n).trigger("showResults",[i])}};e.event.special.showResults={setup:function(){return false},_default:function(t){var n=t.target;var r=e(n).data("smart-autocomplete");var i=e(r.resultsContainer);var s=t.smartAutocompleteData.results;if(r.typeAhead&&s[0].substr(0,e(n).val().length)==e(n).val()){var o=s[0];e(n).before("<input class='smart_autocomplete_type_ahead_field' type='text' autocomplete='off' disabled='disabled' value='"+o+"'/>");e(n).css({position:"relative",zIndex:2,background:"transparent"});var u=e(n).prev("input");u.css({position:"absolute",zIndex:1,overflow:"hidden",background:e(n).css("background"),borderColor:"transparent",width:e(n).width(),color:"silver"});r.currentSelection=0;if(i)e(n).trigger("itemFocus",i.children()[r.currentSelection])}if(i){if(r.alignResultsContainer){i.css({position:"absolute",top:function(){return e(n).offset().top+e(n).height()},left:function(){return e(n).offset().left},width:function(){return e(n).width()},zIndex:1e3})}i.show()}}};e.event.special.noResults={setup:function(){return false},_default:function(t){var n=t.target;var r=e(n).data("smart-autocomplete");var i=e(r.resultsContainer);if(i){r.clearResults()}}};e.event.special.itemSelect={setup:function(){return false},_default:function(t){var n=t.target;var r=e(n).data("smart-autocomplete");var i=t.smartAutocompleteData.item;var s=e(i).text()||e(i).val();e(n).val(s);r.setItemSelected(true);r.originalCharCount=e(n).val().length;e(n).trigger("lostFocus")}};e.event.special.itemFocus={setup:function(){return false},_default:function(t){var n=t.smartAutocompleteData.item;e(n).addClass("smart_autocomplete_highlight")}};e.event.special.itemUnfocus={setup:function(){return false},_default:function(t){var n=t.smartAutocompleteData.item;e(n).removeClass("smart_autocomplete_highlight")}};e.event.special.lostFocus={setup:function(){return false},_default:function(t){var n=t.target;var r=e(n).data("smart-autocomplete");if(r.forceSelect&&!r.itemSelected)e(r.context).val("");r.setAutocompleteFocused(false);r.clearResults();if(r.resultsContainer)e(r.resultsContainer).hide();r.currentSelection=null}};var i=arguments[0];return this.each(function(t){var n=e.extend(r,e(this).data("smart-autocomplete"),i);n["context"]=this;if(e.type(n.resultsContainer)==="undefined"){var s=e("<ul class='smart_autocomplete_container' style='display:none'></ul>");s.appendTo("body");n.resultsContainer=s;n.alignResultsContainer=true}e(this).data("smart-autocomplete",n);e(this).on("keydown",function(t){var n=e(this).data("smart-autocomplete");if(t.keyCode===38){if(n.resultsContainer){var r=n.currentSelection||0;var i=e(n.resultsContainer).children();if(r>0){e(n.context).trigger("itemUnfocus",i[r]);r--}else if(r-1<0){e(n.context).trigger("itemUnfocus",i[r]);r=i.length-1}n.currentSelection=r;e(n.context).trigger("itemFocus",[i[r]])}}else if(t.keyCode===40){if(n.resultsContainer&&n.resultsContainer.is(":visible")){var r=n.currentSelection;var i=e(n.resultsContainer).children();if(r>=0)e(n.context).trigger("itemUnfocus",i[r]);if(isNaN(r)||null==r||++r>=i.length)r=0;n["currentSelection"]=r;e(n.context).trigger("itemFocus",[i[r]])}else{e(n.context).trigger("keyIn",[e(this).val()])}}else if(t.keyCode===39||t.keyCode===13){var s=e(n.context).prev(".smart_autocomplete_type_ahead_field");if(n.resultsContainer&&e(n.resultsContainer).is(":visible")){var r=n.currentSelection;var i=e(n.resultsContainer).children();e(n.context).trigger("itemSelect",[i[r]])}else if(n.typeAhead&&s.is(":visible"))e(n.context).trigger("itemSelect",[s]);return false}else{var o=e(n.context).val().length;if(n.originalCharCount==o)return;if(o>=n.minCharLimit){e(n.context).trigger("keyIn",[e(this).val()])}else{if(n.autocompleteFocused){n.currentSelection=null;e(n.context).trigger("lostFocus")}}}});e(this).focus(function(){e(this).closest("form").bind("keydown.block_for_smart_autocomplete",function(t){var r=e(n.context).prev(".smart_autocomplete_type_ahead_field");if(t.keyCode===13){if(n.resultsContainer&&e(n.resultsContainer).is(":visible")){var i=n.currentSelection;var s=e(n.resultsContainer).children();e(n.context).trigger("itemSelect",[s[i]]);return false}else if(n.typeAhead&&r.is(":visible")){e(n.context).trigger("itemSelect",[r]);return false}}});if(n.forceSelect){e(this).select()}});e(document).bind("focusin click",function(t){if(n.autocompleteFocused){var r=e.contains(n.resultsContainer[0],t.target);if(t.target==n.resultsContainer[0]||t.target==n.context||r)return;e(n.context).closest("form").unbind("keydown.block_for_smart_autocomplete");e(n.context).trigger("lostFocus")}});e(n.resultsContainer).delegate(n.resultElement,"mouseenter.smart_autocomplete",function(){var t=n.currentSelection||0;var r=e(n.resultsContainer).children();n["currentSelection"]=e(this).prevAll().length;if(t!=n.currentSelection){e(n.context).trigger("itemUnfocus",r[t])}e(n.context).trigger("itemFocus",[this])});e(n.resultsContainer).delegate(n.resultElement,"mouseleave.smart_autocomplete",function(){e(n.context).trigger("itemUnfocus",[this])});e(n.resultsContainer).delegate(n.resultElement,"mousedown.smart_autocomplete",function(){e(n.context).trigger("itemSelect",[this]);return false});e(this).bind({keyIn:function(e,t){e.smartAutocompleteData={query:t}},resultsReady:function(e,t){e.smartAutocompleteData={results:t}},showResults:function(e,t){e.smartAutocompleteData={results:t}},noResults:function(){},lostFocus:function(){},itemSelect:function(e,t){e.smartAutocompleteData={item:t}},itemFocus:function(e,t){e.smartAutocompleteData={item:t}},itemUnfocus:function(e,t){e.smartAutocompleteData={item:t}}})})}})(jQuery)